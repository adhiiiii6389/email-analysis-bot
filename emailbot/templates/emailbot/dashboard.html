<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Assistant Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-icon {
            font-size: 2rem;
            opacity: 0.8;
        }
        .urgent-badge {
            background-color: #dc3545;
            color: white;
        }
        .normal-badge {
            background-color: #6c757d;
            color: white;
        }
        .sentiment-positive {
            color: #28a745;
        }
        .sentiment-negative {
            color: #dc3545;
        }
        .sentiment-neutral {
            color: #6c757d;
        }
        .email-item {
            border-left: 4px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .email-item.urgent {
            border-left-color: #dc3545;
        }
        .email-item:hover {
            background-color: #f8f9fa;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-envelope me-2"></i>
                Email Assistant Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/" target="_blank">
                    <i class="fas fa-cog me-1"></i>
                    Admin Panel
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Time Filter and Actions -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="timeFilter" class="form-label">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Time Period
                                </label>
                                <select class="form-select" id="timeFilter" onchange="filterByTime()">
                                    <option value="today" selected>Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="this-week">This Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-robot me-2"></i>
                                    Auto Respond
                                </label>
                                <div>
                                    <button class="btn btn-primary" id="autoRespondBtn" onclick="autoRespondDisplayedEmails()">
                                        <i class="fas fa-paper-plane me-2"></i>
                                        Send Auto Responses
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Actions
                                </label>
                                <div>
                                    <button class="btn btn-outline-primary" onclick="refreshData()">
                                        <i class="fas fa-refresh me-2"></i>
                                        Refresh Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-clock me-2"></i>
                            Current Filter
                        </h5>
                        <h4 id="currentFilterLabel">Today</h4>
                        <small id="filterDescription">Showing emails from today</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Total Emails</h5>
                            <h2 class="mb-0" id="total-emails">0</h2>
                            <small>Today</small>
                        </div>
                        <i class="fas fa-envelope card-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-danger">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Urgent</h5>
                            <h2 class="mb-0" id="urgent-emails">0</h2>
                            <small>Needs attention</small>
                        </div>
                        <i class="fas fa-exclamation-triangle card-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-warning">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Pending</h5>
                            <h2 class="mb-0" id="pending-emails">0</h2>
                            <small>Awaiting response</small>
                        </div>
                        <i class="fas fa-clock card-icon"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-success">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Responded</h5>
                            <h2 class="mb-0" id="responded-emails">0</h2>
                            <small>Today</small>
                        </div>
                        <i class="fas fa-check-circle card-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Sentiment Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="sentimentChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Categories
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Recent Emails
                        </h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="loading text-center p-3">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Loading emails...</p>
                        </div>
                        <div id="email-list">
                            <!-- Email items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Detail Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailModalLabel">Email Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="emailModalBody">
                    <!-- Email details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="markRespondedBtn">Mark as Responded</button>
                    <button type="button" class="btn btn-primary" id="regenerateResponseBtn">Regenerate Response</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sentimentChart, categoryChart;
        let currentEmailId = null;
        let currentTimeFilter = 'today';
        let displayedEmails = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            initializeCharts();
        });

        async function loadDashboardData(timeFilter = 'today') {
            try {
                showLoading(true);
                currentTimeFilter = timeFilter;
                
                // Load dashboard overview with time filter
                const overviewResponse = await fetch(`/api/dashboard/overview/?time_filter=${timeFilter}`);
                const overviewData = await overviewResponse.json();
                
                // Load filtered emails
                const emailsResponse = await fetch(`/api/emails/by_time/?time_filter=${timeFilter}`);
                const emailsData = await emailsResponse.json();
                
                updateStats(overviewData);
                updateCharts(overviewData);
                updateEmailList(emailsData.results || emailsData);
                updateFilterInfo(timeFilter);
                
                // Store displayed emails for auto-respond
                displayedEmails = emailsData.results || emailsData;
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            } finally {
                showLoading(false);
            }
        }

        function filterByTime() {
            const timeFilter = document.getElementById('timeFilter').value;
            loadDashboardData(timeFilter);
        }

        function updateFilterInfo(timeFilter) {
            const filterLabel = document.getElementById('currentFilterLabel');
            const filterDescription = document.getElementById('filterDescription');
            
            const filterMap = {
                'today': { label: 'Today', desc: 'Showing emails from today' },
                'yesterday': { label: 'Yesterday', desc: 'Showing emails from yesterday' },
                'this-week': { label: 'This Week', desc: 'Showing emails from last 7 days' },
                'this-month': { label: 'This Month', desc: 'Showing emails from last 30 days' },
                'all': { label: 'All Time', desc: 'Showing all emails' }
            };
            
            const filter = filterMap[timeFilter] || filterMap['today'];
            filterLabel.textContent = filter.label;
            filterDescription.textContent = filter.desc;
        }

        async function autoRespondDisplayedEmails() {
            const btn = document.getElementById('autoRespondBtn');
            const originalText = btn.innerHTML;
            
            try {
                // Show loading state
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending Responses...';
                
                // Filter emails that haven't been responded to yet
                const unrespondedEmails = displayedEmails.filter(email => !email.is_responded);
                
                if (unrespondedEmails.length === 0) {
                    showSuccess('All displayed emails have already been responded to!');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                // Process each unresponded email
                for (const email of unrespondedEmails) {
                    try {
                        // Generate and send response
                        const generateResponse = await fetch(`/api/emails/${email.id}/generate_response/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ 
                                auto_respond: true,
                                time_filter: currentTimeFilter 
                            })
                        });
                        
                        if (generateResponse.ok) {
                            // Mark as responded
                            const markResponse = await fetch(`/api/emails/${email.id}/mark_responded/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                }
                            });
                            
                            if (markResponse.ok) {
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                        
                        // Small delay to avoid overwhelming the API
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`Error processing email ${email.id}:`, error);
                        errorCount++;
                    }
                }
                
                // Show results
                if (successCount > 0) {
                    showSuccess(`Auto-responded to ${successCount} emails successfully!`);
                }
                if (errorCount > 0) {
                    showError(`Failed to respond to ${errorCount} emails.`);
                }
                
                // Refresh the dashboard to show updated status
                loadDashboardData(currentTimeFilter);
                
            } catch (error) {
                console.error('Error in auto-respond process:', error);
                showError('Failed to auto-respond to emails');
            } finally {
                // Reset button
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function updateStats(data) {
            const stats = data.today_stats;
            document.getElementById('total-emails').textContent = stats.total_emails || 0;
            document.getElementById('urgent-emails').textContent = data.urgent_count || 0;
            document.getElementById('pending-emails').textContent = data.pending_count || 0;
            document.getElementById('responded-emails').textContent = stats.responded_emails || 0;
        }

        function initializeCharts() {
            // Sentiment Chart
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(sentimentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Neutral'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#28a745', '#dc3545', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: ['Technical', 'Account', 'Product', 'Billing', 'General'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: '#007bff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateCharts(data) {
            // Update sentiment chart
            const sentimentData = data.sentiment_breakdown;
            sentimentChart.data.datasets[0].data = [
                sentimentData.positive || 0,
                sentimentData.negative || 0,
                sentimentData.neutral || 0
            ];
            sentimentChart.update();

            // Update category chart
            const categoryData = data.category_breakdown;
            categoryChart.data.datasets[0].data = [
                categoryData.technical_issue || 0,
                categoryData.account_support || 0,
                categoryData.product_inquiry || 0,
                categoryData.billing || 0,
                categoryData.general || 0
            ];
            categoryChart.update();
        }

        function updateEmailList(emails) {
            const emailList = document.getElementById('email-list');
            
            if (emails.length === 0) {
                emailList.innerHTML = '<div class="text-center text-muted p-4">No emails found</div>';
                return;
            }

            const emailsHtml = emails.map(email => `
                <div class="email-item p-3 mb-2 border rounded ${email.is_urgent ? 'urgent' : ''}" 
                     style="cursor: pointer;" onclick="showEmailDetail(${email.id})">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <strong class="me-2">${email.sender_email}</strong>
                                <span class="badge ${email.priority === 'urgent' ? 'urgent-badge' : 'normal-badge'} me-2">
                                    ${email.priority_display}
                                </span>
                                <span class="badge bg-light text-dark me-2">${email.category_display || 'Uncategorized'}</span>
                                ${email.is_responded ? '<span class="badge bg-success">Responded</span>' : '<span class="badge bg-warning text-dark">Pending</span>'}
                            </div>
                            <div class="mb-1">
                                <strong>${email.subject}</strong>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                ${new Date(email.received_at).toLocaleString()}
                                <span class="sentiment-${email.sentiment} ms-2">
                                    <i class="fas fa-circle"></i> ${email.sentiment_display}
                                </span>
                            </small>
                        </div>
                        ${email.is_urgent ? '<i class="fas fa-exclamation-triangle text-danger"></i>' : ''}
                    </div>
                </div>
            `).join('');

            emailList.innerHTML = emailsHtml;
        }

        async function showEmailDetail(emailId) {
            try {
                const response = await fetch(`/api/emails/${emailId}/`);
                const email = await response.json();
                
                currentEmailId = emailId;
                
                const modalBody = document.getElementById('emailModalBody');
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Email Information</h6>
                            <p><strong>From:</strong> ${email.sender_email}</p>
                            <p><strong>Subject:</strong> ${email.subject}</p>
                            <p><strong>Received:</strong> ${new Date(email.received_at).toLocaleString()}</p>
                            <p><strong>Priority:</strong> 
                                <span class="badge ${email.priority === 'urgent' ? 'urgent-badge' : 'normal-badge'}">
                                    ${email.priority_display}
                                </span>
                            </p>
                            <p><strong>Category:</strong> ${email.category_display || 'Uncategorized'}</p>
                            <p><strong>Sentiment:</strong> 
                                <span class="sentiment-${email.sentiment}">${email.sentiment_display}</span>
                                ${email.sentiment_confidence ? `(${Math.round(email.sentiment_confidence * 100)}% confidence)` : ''}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6>Extracted Information</h6>
                            <div class="small">
                                ${formatExtractedInfo(email.extracted_info)}
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6>Email Body</h6>
                            <div class="border p-3 mb-3" style="max-height: 200px; overflow-y: auto;">
                                ${email.body.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6>AI Generated Response</h6>
                            <div class="border p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                ${email.ai_response ? email.ai_response.replace(/\n/g, '<br>') : 'No response generated yet'}
                            </div>
                            ${email.response_generated_at ? `<small class="text-muted">Generated: ${new Date(email.response_generated_at).toLocaleString()}</small>` : ''}
                        </div>
                    </div>
                `;
                
                // Show/hide buttons based on email status
                document.getElementById('markRespondedBtn').style.display = email.is_responded ? 'none' : 'inline-block';
                
                const modal = new bootstrap.Modal(document.getElementById('emailModal'));
                modal.show();
                
            } catch (error) {
                console.error('Error loading email details:', error);
                showError('Failed to load email details');
            }
        }

        function formatExtractedInfo(info) {
            if (!info || Object.keys(info).length === 0) {
                return '<em>No extracted information</em>';
            }
            
            let html = '';
            
            if (info.phone_numbers && info.phone_numbers.length > 0) {
                html += `<p><strong>Phone:</strong> ${info.phone_numbers.join(', ')}</p>`;
            }
            
            if (info.alternate_emails && info.alternate_emails.length > 0) {
                html += `<p><strong>Alt. Emails:</strong> ${info.alternate_emails.join(', ')}</p>`;
            }
            
            if (info.requirements) {
                html += `<p><strong>Requirements:</strong> ${info.requirements}</p>`;
            }
            
            if (info.deadlines) {
                html += `<p><strong>Deadlines:</strong> ${info.deadlines}</p>`;
            }
            
            if (info.technical_details) {
                html += `<p><strong>Technical:</strong> ${info.technical_details}</p>`;
            }
            
            if (info.business_context) {
                html += `<p><strong>Business:</strong> ${info.business_context}</p>`;
            }
            
            return html || '<em>No extracted information</em>';
        }

        // Button event handlers
        document.getElementById('markRespondedBtn').addEventListener('click', async function() {
            if (!currentEmailId) return;
            
            try {
                const response = await fetch(`/api/emails/${currentEmailId}/mark_responded/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
                    showSuccess('Email marked as responded');
                    loadDashboardData();
                } else {
                    showError('Failed to mark email as responded');
                }
            } catch (error) {
                console.error('Error marking email as responded:', error);
                showError('Failed to mark email as responded');
            }
        });

        document.getElementById('regenerateResponseBtn').addEventListener('click', async function() {
            if (!currentEmailId) return;
            
            try {
                const response = await fetch(`/api/emails/${currentEmailId}/generate_response/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ regenerate: true })
                });
                
                if (response.ok) {
                    showSuccess('Response regenerated successfully');
                    showEmailDetail(currentEmailId); // Refresh the modal
                } else {
                    showError('Failed to regenerate response');
                }
            } catch (error) {
                console.error('Error regenerating response:', error);
                showError('Failed to regenerate response');
            }
        });

        function refreshData() {
            loadDashboardData(currentTimeFilter);
        }

        function showLoading(show) {
            const loading = document.querySelector('.loading');
            if (show) {
                loading.style.display = 'block';
            } else {
                loading.style.display = 'none';
            }
        }

        function showSuccess(message) {
            // Simple alert for now - you can replace with toast notifications
            alert('Success: ' + message);
        }

        function showError(message) {
            // Simple alert for now - you can replace with toast notifications
            alert('Error: ' + message);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Add CSRF token to page
        const csrfToken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || 'dummy-token';
    </script>
</body>
</html>
